<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dateien mit fester Verteilung erzeugen</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Dateien mit fester Verteilung erzeugen</h1>
<div class="slides">
<div>
<div>
<h1>Dateien mit fester Verteilung erzeugen</h1>
</div>
<ul><li>
die Programme <code><span class="var">ana</span></code> und <code><span class="var">gen</span></code> können Dateien analysieren
</li><li>
und neue Dateien erzeugen, welche die gleiche Verteilung der  enthaltenen Bytes haben
</li></ul>
</div>
</div>
<h2>Dateien analysieren</h2>
<div class="slides">
<div>
<div>
<h2>Dateien analysieren</h2>
</div>
<ul><li>
<code><span class="var">ana</span></code> erstellt Statistiken der Verteilungen von Byte-Folgen in  Dateien
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">file: ana.cpp</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">ana main prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">main</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">argc</span>, <span class="type">const</span> <span class="type">char</span> *<span class="var">argv</span>[]<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">parse args</span>)</span>;<br/>
<span class="in2"></span><span class="type">char</span> <span class="var">ch</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">read input</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">write table</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">file: ana.cpp</span>)</span><br/>
</code></div>
<ul><li>
die Funktion <code><span class="fn">main</span></code> wertet Argumente der Kommandozeile aus
</li><li>
dann liest <code><span class="fn">main</span></code> die Standard-Eingabe komplett und wertet sie aus
</li><li>
zum Schluss schreibt <code><span class="fn">main</span></code> die resultierende Statistik in die  Standard-Eingabe
</li></ul>
</div>
</div>
<h3>Einfache Statistik</h3>
<div class="slides">
<div>
<div>
<h3>Einfache Statistik</h3>
</div>
<ul><li>
zuerst zählt <code><span class="var">ana</span></code> nur Häufigkeiten von Bytes
</li><li>
mit späteren Änderungen zählt es Byte-Folgen einer festen Länge
</li><li>
aber zum Anfang werden nur einzelne Bytes berücksichtigt
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">ana main prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">iostream</span>&gt;<br/>
<span class="macro">@end(<span class="name">ana main prereqs</span>)</span><br/>
</code></div>
<ul><li>
benötigt Standard Ein- und Ausgabe
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">def collection</span>)</span><br/>
<span class="in1"></span><span class="keyword">using</span> <span class="type">Collection</span> =<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">map</span>&lt;<span class="type">char</span>, <span class="type">int</span>&gt;;<br/>
<span class="macro">@end(<span class="name">def collection</span>)</span><br/>
</code></div>
<ul><li>
für jedes Byte wird ein eigener Zähler benutzt
</li><li>
eigenes Fragment, da es später überschrieben wird
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">ana main prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">map</span>&gt;<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">def collection</span>)</span>;<br/>
<span class="in1"></span><span class="type">Collection</span> <span class="var">collection</span>;<br/>
<span class="macro">@end(<span class="name">ana main prereqs</span>)</span><br/>
</code></div>
<ul><li>
es gibt eine globale Variable mit den Häufigkeiten
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">read input</span>)</span><br/>
<span class="in1"></span><span class="keyword">while</span> (<span class="type">std</span>::<span class="var">cin</span>.<span class="fn">get</span>(<span class="var">ch</span>)) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add to collection</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">read input</span>)</span><br/>
</code></div>
<ul><li>
jedes gelesene Zeichen wird in die Statistik integriert
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add to collection</span>)</span><br/>
<span class="in1"></span>++<span class="var">collection</span>[<span class="var">ch</span>];<br/>
<span class="macro">@end(<span class="name">add to collection</span>)</span><br/>
</code></div>
<ul><li>
fügt Zeichen in die Statistik ein
</li><li>
eigenes Fragment, um es später zu ersetzen
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">write table</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">e</span> : <span class="var">collection</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">write key</span>)</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"\t"</span> &lt;&lt;<br/>
<span class="in3"></span><span class="var">e</span>.<span class="var">second</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">write table</span>)</span><br/>
</code></div>
<ul><li>
jeder Eintrag der Statistik wird ausgegeben
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">ana main prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cctype</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">write_byte</span>(<span class="type">char</span> <span class="var">b</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">isprint</span>(<span class="var">b</span>) &amp;&amp;<br/>
<span class="in3"></span><span class="var">b</span> != <span class="str">'%'</span> &amp;&amp; <span class="var">b</span> &gt; <span class="str">' '</span><br/>
<span class="in2"></span>) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">b</span>;<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="keyword">static</span> <span class="type">const</span> <span class="type">char</span> <span class="var">digits</span>[] =<br/>
<span class="in4"></span><span class="str">"0123456789abcdef"</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">'%'</span> &lt;&lt;<br/>
<span class="in4"></span><span class="var">digits</span>[(<span class="var">b</span> &gt;&gt; <span class="num">4</span>) &amp; <span class="num">0xf</span>] &lt;&lt;<br/>
<span class="in4"></span><span class="var">digits</span>[<span class="var">b</span> &amp; <span class="num">0xf</span>];<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">ana main prereqs</span>)</span><br/>
</code></div>
<ul><li>
druckbare Zeichen werden direkt ausgegeben
</li><li>
andere Bytes werden mit dem Präfix <code>\<span class="var">x</span></code> als zwei hexadezimale Ziffern  ausgegeben
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">write key</span>)</span><br/>
<span class="in1"></span><span class="fn">write_byte</span>(<span class="var">e</span>.<span class="var">first</span>);<br/>
<span class="macro">@end(<span class="name">write key</span>)</span><br/>
</code></div>
<ul><li>
gibt den Schlüssel aus
</li><li>
eigenes Fragment, da sich der Typ des Schlüssels später ändert
</li></ul>
</div>
</div>
<h3>Byte-Folgen analysieren</h3>
<div class="slides">
<div>
<div>
<h3>Byte-Folgen analysieren</h3>
</div>
<ul><li>
passt das Programm an, um ganze Byte-Folgen fester Länge zu analysieren
</li><li>
anstatt nur einzelner Bytes
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">write key</span>)</span><br/>
<span class="macro">@end(<span class="name">write key</span>)</span><br/>
</code></div>
<ul><li>
löscht das Fragment, da es sonst Zwischenstände gibt, die nicht  kompilieren
</li><li>
nach der Typ-Änderung werden die Fragmente neu gefüllt
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">add to collection</span>)</span><br/>
<span class="macro">@end(<span class="name">add to collection</span>)</span><br/>
</code></div>
<ul><li>
löscht das Fragment, da es sonst Zwischenstände gibt, die nicht  kompilieren
</li><li>
nach der Typ-Änderung werden die Fragmente neu gefüllt
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">def collection prereqs</span>)</span><br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">key class</span>)</span>;<br/>
<span class="macro">@end(<span class="name">def collection prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">key class</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">key prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">memory</span>&gt;<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Key</span> {<br/>
<span class="in2"></span><span class="keyword">private</span>:<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">char</span>&gt; <span class="var">_key</span>;<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">key publics</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">key impl</span>)</span>;<br/>
<span class="macro">@end(<span class="name">key class</span>)</span><br/>
</code></div>
<ul><li>
die <code><span class="type">Key</span></code> Klasse enthält die Byte-Folgen
</li><li>
eine eigene Klasse wird verwendet, da sie kompakter als <code><span class="type">std</span>::<span class="type">vector</span></code>  implementiert werden kann
</li><li>
aber die Länge des Schlüssels nicht zum Zeitpunkt der Übersetzung  bekannt ist
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="keyword">static</span> <span class="type">int</span> <span class="var">length</span>;<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
verwendete Schlüssel-Länge ist eine statische Variable
</li><li>
sauberer wäre es, sie in jede <code><span class="type">Key</span></code>-Instanz abzulegen, aber das  würde viel Speicher verbrauchen
</li><li>
der Wert <code><span class="var">length</span></code> wird nur geändert, bevor viele <code><span class="type">Key</span></code>s instantiiert  wurden
</li><li>
diese müssen manuell korrigiert werden
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">key impl</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="type">Key</span>::<span class="var">length</span> { <span class="num">2</span> };<br/>
<span class="macro">@end(<span class="name">key impl</span>)</span><br/>
</code></div>
<ul><li>
als Vorgabe betrachtet <code><span class="var">app</span></code> Byte-Folgen der Länge 2
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">key prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cstring</span>&gt;<br/>
<span class="macro">@end(<span class="name">key prereqs</span>)</span><br/>
</code></div>
<ul><li>
benötigt Speicher-Funktionen/Makros
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="fn">Key</span>():<br/>
<span class="in2"></span><span class="var">_key</span> { <span class="keyword">new</span> <span class="type">char</span>[<span class="var">length</span>] }<br/>
<span class="in1"></span>{<br/>
<span class="in2"></span><span class="fn">memset</span>(&amp;*<span class="var">_key</span>, <span class="num">0</span>, <span class="var">length</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
Konstruktor legt Speicher an und initialisiert Bytes
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="fn">Key</span>(<span class="type">const</span> <span class="type">Key</span> &amp;<span class="var">other</span>):<br/>
<span class="in2"></span><span class="var">_key</span> { <span class="keyword">new</span> <span class="type">char</span>[<span class="var">length</span>] }<br/>
<span class="in1"></span>{<br/>
<span class="in2"></span><span class="fn">memcpy</span>(<br/>
<span class="in3"></span>&amp;*<span class="var">_key</span>, &amp;*<span class="var">other</span>.<span class="var">_key</span>, <span class="var">length</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
Copy-Konstruktor legt einen eigenen Speicherbereich an
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="type">Key</span> &amp;<span class="var">operator</span>=(<span class="type">const</span> <span class="type">Key</span> &amp;<span class="var">other</span>) {<br/>
<span class="in2"></span><span class="fn">memcpy</span>(<br/>
<span class="in3"></span>&amp;*<span class="var">_key</span>, &amp;*<span class="var">other</span>.<span class="var">_key</span>, <span class="var">length</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span><span class="keyword">return</span> *<span class="var">this</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
Assignment kopiert nur die Speicherbereiche
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">operator</span>==(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Key</span> &amp;<span class="var">other</span><br/>
<span class="in1"></span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">memcmp</span>(<br/>
<span class="in3"></span>&amp;*<span class="var">_key</span>, &amp;*<span class="var">other</span>.<span class="var">_key</span>, <span class="var">length</span><br/>
<span class="in2"></span>) == <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
Gleichheit wird über die Speicherbereiche definiert
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">operator</span>&lt;(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Key</span> &amp;<span class="var">other</span><br/>
<span class="in1"></span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">memcmp</span>(<br/>
<span class="in3"></span>&amp;*<span class="var">_key</span>, &amp;*<span class="var">other</span>.<span class="var">_key</span>, <span class="var">length</span><br/>
<span class="in2"></span>) &lt; <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
Ordnung wird über die Speicherbereiche definiert
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">def collection</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">def collection prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">using</span> <span class="type">Collection</span> =<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">map</span>&lt;<span class="type">Key</span>, <span class="type">int</span>&gt;;<br/>
<span class="in1"></span><span class="type">Key</span> <span class="var">key</span>;<br/>
<span class="macro">@end(<span class="name">def collection</span>)</span><br/>
</code></div>
<ul><li>
Collection zählt nun <code><span class="type">Key</span></code> Instanzen
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">push</span>(<span class="type">char</span> <span class="var">ch</span>) {<br/>
<span class="in2"></span><span class="fn">memmove</span>(<br/>
<span class="in3"></span>&amp;*<span class="var">_key</span>, &amp;*<span class="var">_key</span> + <span class="num">1</span>,<br/>
<span class="in3"></span><span class="var">length</span> - <span class="num">1</span><br/>
<span class="in2"></span>);<br/>
<span class="in2"></span>(&amp;*<span class="var">_key</span>)[<span class="var">length</span> - <span class="num">1</span>] = <span class="var">ch</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
verschiebt die bestehenden Zeichen im Schlüssel
</li><li>
und fügt das neue Byte am Ende ein
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">add to collection</span>)</span><br/>
<span class="in1"></span><span class="var">key</span>.<span class="fn">push</span>(<span class="var">ch</span>);<br/>
<span class="in1"></span>++<span class="var">collection</span>[<span class="var">key</span>];<br/>
<span class="macro">@end(<span class="name">add to collection</span>)</span><br/>
</code></div>
<ul><li>
passt Schlüssel an
</li><li>
und zählt neuen Schlüssel 
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">key publics</span>)</span><br/>
<span class="in1"></span><span class="type">char</span> <span class="var">operator</span>[](<span class="type">int</span> <span class="var">i</span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> (&amp;*<span class="var">_key</span>)[<span class="var">i</span>];<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">key publics</span>)</span><br/>
</code></div>
<ul><li>
liefert einzelnes Byte des Schlüssels
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">write key</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">i</span> = <span class="num">0</span>; <span class="var">i</span> &lt; <span class="type">Key</span>::<span class="var">length</span>; ++<span class="var">i</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">write_byte</span>(<span class="var">e</span>.<span class="var">first</span>[<span class="var">i</span>]);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">write key</span>)</span><br/>
</code></div>
<ul><li>
gibt alle Bytes des Schlüssels aus
</li></ul>
</div>
</div>
<h3>Andere Längen der Byte-Folgen</h3>
<div class="slides">
<div>
<div>
<h3>Andere Längen der Byte-Folgen</h3>
</div>
<ul><li>
als Vorgabe werden Byte-Folgen der Länge 2 betrachtet
</li><li>
um andere Längen zu verwenden, kann die neue Länge mit der Option  <code>-<span class="var">n</span></code> auf der Kommandozeile angegeben werden
</li><li>
so betrachtet zum Beispiel <code>-<span class="var">n3</span></code> Byte-Folgen der Länge 3
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">parse args</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">argc</span> == <span class="num">2</span>) {<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">arg</span> { <span class="var">argv</span>[<span class="num">1</span>] };<br/>
<span class="in2"></span><span class="keyword">if</span> (<br/>
<span class="in3"></span><span class="var">arg</span>[<span class="num">0</span>] == <span class="str">'-'</span> &amp;&amp;<br/>
<span class="in4"></span><span class="var">arg</span>[<span class="num">1</span>] == <span class="str">'n'</span><br/>
<span class="in2"></span>) {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">change length</span>)</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">parse args</span>)</span><br/>
</code></div>
<ul><li>
bearbeite Option <code>-<span class="var">n</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">change length</span>)</span><br/>
<span class="in1"></span><span class="type">Key</span>::<span class="var">length</span> = <span class="type">std</span>::<span class="fn">stoi</span>(<span class="var">arg</span> + <span class="num">2</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="type">Key</span>::<span class="var">length</span> &lt; <span class="num">1</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"wrong length\n"</span>;<br/>
<span class="in2"></span><span class="type">Key</span>::<span class="var">length</span> = <span class="num">2</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">key</span>.~<span class="fn">Key</span>();<br/>
<span class="in1"></span><span class="keyword">new</span> (&amp;<span class="var">key</span>) <span class="type">Key</span> { };<br/>
<span class="macro">@end(<span class="name">change length</span>)</span><br/>
</code></div>
<ul><li>
setze neue Länge
</li><li>
<code><span class="var">key</span></code> wird neu instantiiert
</li><li>
wenn die Länge zu kurz ist, wird statt dessen 2 verwendet
</li></ul>
</div>
</div>
<h2>Dokumente generieren</h2>
<div class="slides">
<div>
<div>
<h2>Dokumente generieren</h2>
</div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">file: gen.cpp</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">gen main prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">main</span>() {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">read receipt</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">gen loop</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">file: gen.cpp</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">gen main prereqs</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">static next prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">next prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">bool</span> <span class="fn">next</span>(<span class="type">char</span> &amp;<span class="var">ch</span>) {<br/>
<span class="in2"></span><span class="type">bool</span> <span class="var">ok</span> { <span class="num">false</span> };<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">next</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">ok</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">gen main prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">gen main prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">iostream</span>&gt;<br/>
<span class="macro">@end(<span class="name">gen main prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">gen loop</span>)</span><br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">initialise</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">for</span> (;;) {<br/>
<span class="in2"></span><span class="type">char</span> <span class="var">ch</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">next</span>(<span class="var">ch</span>)) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">ch</span>;<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="macro">@mul(<span class="name">initialise</span>)</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">gen loop</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">next</span>)</span><br/>
<span class="in1"></span><span class="var">ch</span> = <span class="str">'x'</span>;<br/>
<span class="in1"></span><span class="var">ok</span> = <span class="num">true</span>;<br/>
<span class="macro">@end(<span class="name">next</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">initialise</span>)</span><br/>
<span class="macro">@end(<span class="name">initialise</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">next prereqs</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">prev_length</span> { <span class="num">3</span> };<br/>
<span class="in1"></span><span class="type">char</span> *<span class="var">previous</span> { <span class="num">nullptr</span> };<br/>
<span class="macro">@end(<span class="name">next prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">initialise</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">previous</span>) {<br/>
<span class="in2"></span><span class="var">previous</span> =<br/>
<span class="in3"></span><span class="keyword">new</span> <span class="type">char</span>[<span class="var">prev_length</span>];<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">0</span>] = <span class="str">'a'</span>;<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">1</span>] = <span class="str">'b'</span>;<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">2</span>] = <span class="str">'c'</span>;<br/>
<span class="macro">@end(<span class="name">initialise</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">next</span>)</span><br/>
<span class="in1"></span><span class="var">ch</span> = <span class="var">previous</span>[<span class="num">0</span>];<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">0</span>] = <span class="var">previous</span>[<span class="num">1</span>];<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">1</span>] = <span class="var">previous</span>[<span class="num">2</span>];<br/>
<span class="in1"></span><span class="var">previous</span>[<span class="num">2</span>] = <span class="var">ch</span>;<br/>
<span class="in1"></span><span class="var">ok</span> = <span class="num">true</span>;<br/>
<span class="macro">@end(<span class="name">next</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">gen main prereqs</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">hex_digit</span>(<span class="type">char</span> <span class="var">ch</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">ch</span> &gt;= <span class="str">'0'</span> &amp;&amp; <span class="var">ch</span> &lt;= <span class="str">'9'</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">ch</span> - <span class="str">'0'</span>;<br/>
<span class="in2"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="var">ch</span> &gt;= <span class="str">'a'</span> &amp;&amp; <span class="var">ch</span> &lt;= <span class="str">'f'</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">ch</span> - <span class="str">'a'</span> + <span class="num">10</span>;<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"invalid digit\n"</span>;<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">0</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">std</span>::<span class="type">string</span> <span class="fn">normalize</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">key</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">result</span>;<br/>
<span class="in2"></span><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="var">i</span> { <span class="num">0</span> }; <span class="var">i</span> &lt; <span class="var">key</span>.<span class="fn">size</span>(); ++<span class="var">i</span>) {<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">key</span>[<span class="var">i</span>] == <span class="str">'%'</span>) {<br/>
<span class="in4"></span><span class="var">result</span> += <span class="var">static_cast</span>&lt;<span class="type">char</span>&gt;(<br/>
<span class="in5"></span>(<span class="fn">hex_digit</span>(<span class="var">key</span>[<span class="var">i</span> + <span class="num">1</span>]) &lt;&lt; <span class="num">4</span>) + <span class="fn">hex_digit</span>(<span class="var">key</span>[<span class="var">i</span> + <span class="num">2</span>])<br/>
<span class="in4"></span>);<br/>
<span class="in4"></span><span class="var">i</span> += <span class="num">2</span>;<br/>
<span class="in3"></span>} <span class="keyword">else</span> {<br/>
<span class="in4"></span><span class="var">result</span> += <span class="var">key</span>[<span class="var">i</span>];<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">gen main prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">static next prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">memory</span>&gt;<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cassert</span>&gt;<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">random</span>&gt;<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Entry</span> {<br/>
<span class="in2"></span><span class="keyword">private</span>:<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Entry</span>&gt; <span class="var">_next</span>;<br/>
<span class="in3"></span><span class="type">char</span> <span class="var">_ch</span>;<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">_count</span>;<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Entry</span>(<span class="type">char</span> <span class="var">ch</span>, <span class="type">int</span> <span class="var">count</span>): <span class="var">_ch</span> { <span class="var">ch</span> }, <span class="var">_count</span> { <span class="var">count</span>} { }<br/>
<span class="in3"></span><span class="type">char</span> <span class="fn">ch</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_ch</span>; }<br/>
<span class="in3"></span><span class="type">int</span> <span class="fn">count</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_count</span>; }<br/>
<span class="in3"></span><span class="type">bool</span> <span class="fn">last</span>() <span class="type">const</span> { <span class="keyword">return</span> ! <span class="var">_next</span>; }<br/>
<span class="in3"></span><span class="type">Entry</span> &amp;<span class="fn">next</span>() <span class="type">const</span> { <span class="keyword">return</span> *<span class="var">_next</span>; }<br/>
<span class="in3"></span><span class="type">void</span> <span class="fn">add</span>(<span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Entry</span>&gt; &amp;&amp;<span class="var">entry</span>) {<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="fn">last</span>()) {<br/>
<span class="in5"></span><span class="var">_next</span> = <span class="type">std</span>::<span class="fn">move</span>(<span class="var">entry</span>);<br/>
<span class="in4"></span>} <span class="keyword">else</span> {<br/>
<span class="in5"></span><span class="var">_next</span>-&gt;<span class="fn">add</span>(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">entry</span>));<br/>
<span class="in4"></span>}<br/>
<span class="in3"></span>}<br/>
<span class="in1"></span>};<br/>
<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">random_device</span> <span class="var">_dev</span>;<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">mt19937</span> <span class="var">_rng</span> { <span class="fn">_dev</span>() };<br/>
<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">List</span> {<br/>
<span class="in2"></span><span class="keyword">private</span>:<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Entry</span>&gt; <span class="var">_entries</span>;<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">_sum</span> { <span class="num">0</span> };<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="type">void</span> <span class="fn">add</span>(<span class="type">char</span> <span class="var">ch</span>, <span class="type">int</span> <span class="var">count</span>) {<br/>
<span class="in4"></span><span class="type">auto</span> <span class="var">entry</span> { <span class="type">std</span>::<span class="var">make_unique</span>&lt;<span class="type">Entry</span>&gt;(<span class="var">ch</span>, <span class="var">count</span>) };<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">_entries</span>) {<br/>
<span class="in5"></span><span class="var">_entries</span>-&gt;<span class="fn">add</span>(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">entry</span>));<br/>
<span class="in4"></span>} <span class="keyword">else</span> {<br/>
<span class="in5"></span><span class="var">_entries</span> = <span class="type">std</span>::<span class="fn">move</span>(<span class="var">entry</span>);<br/>
<span class="in4"></span>}<br/>
<span class="in4"></span><span class="var">_sum</span> += <span class="var">count</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="type">char</span> <span class="fn">next</span>() {<br/>
<span class="in4"></span><span class="fn">assert</span>(<span class="var">_sum</span> &gt; <span class="num">0</span>);<br/>
<span class="in4"></span><span class="type">auto</span> <span class="var">dist</span> { <span class="type">std</span>::<span class="var">uniform_int_distribution</span>&lt;<span class="type">std</span>::<span class="var">mt19937</span>::<span class="var">result_type</span>&gt;(<span class="num">0</span>, <span class="var">_sum</span> - <span class="num">1</span>) };<br/>
<span class="in4"></span><span class="type">int</span> <span class="var">result</span> = <span class="fn">dist</span>(<span class="var">_rng</span>);<br/>
<span class="in4"></span><span class="keyword">for</span> (<span class="type">Entry</span> *<span class="var">e</span> { &amp;*<span class="var">_entries</span> };; <span class="var">e</span> = &amp;<span class="var">e</span>-&gt;<span class="fn">next</span>()) {<br/>
<span class="in5"></span><span class="keyword">if</span> (<span class="var">result</span> &lt; <span class="var">e</span>-&gt;<span class="fn">count</span>()) {<br/>
<span class="in6"></span><span class="keyword">return</span> <span class="var">e</span>-&gt;<span class="fn">ch</span>();<br/>
<span class="in5"></span>}<br/>
<span class="in5"></span><span class="var">result</span> -= <span class="var">e</span>-&gt;<span class="fn">count</span>();<br/>
<span class="in5"></span><span class="keyword">if</span> (<span class="var">e</span>-&gt;<span class="fn">last</span>()) { <span class="keyword">break</span>; }<br/>
<span class="in4"></span>}<br/>
<span class="in4"></span><span class="keyword">return</span> <span class="str">'\0'</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in1"></span>};<br/>
<br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">key class</span>)</span>;<br/>
<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">map</span>&gt;<br/>
<span class="in1"></span><span class="keyword">using</span> <span class="type">Collection</span> = <span class="type">std</span>::<span class="type">map</span>&lt;<span class="type">Key</span>, <span class="type">List</span>&gt;;<br/>
<span class="in1"></span><span class="type">Collection</span> <span class="var">collection</span>;<br/>
<span class="macro">@end(<span class="name">static next prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">read receipt</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">first</span> { <span class="num">true</span> };<br/>
<span class="in1"></span><span class="type">Key</span> <span class="var">k</span>;<br/>
<span class="in1"></span><span class="keyword">for</span> (;;) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">key</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cin</span> &gt;&gt; <span class="var">key</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="type">std</span>::<span class="var">cin</span>) { <span class="keyword">break</span>; }<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">count</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cin</span> &gt;&gt; <span class="var">count</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="type">std</span>::<span class="var">cin</span>) { <span class="keyword">break</span>; }<br/>
<span class="in2"></span><span class="var">key</span> = <span class="fn">normalize</span>(<span class="var">key</span>);<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">first</span>) {<br/>
<span class="in3"></span><span class="type">Key</span>::<span class="var">length</span> = <span class="var">key</span>.<span class="fn">size</span>() - <span class="num">1</span>;<br/>
<span class="in3"></span><span class="var">first</span> = <span class="num">false</span>;<br/>
<span class="in3"></span><span class="var">k</span>.~<span class="fn">Key</span>();<br/>
<span class="in3"></span><span class="keyword">new</span> (&amp;<span class="var">k</span>) <span class="type">Key</span> { };<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add entry</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">read receipt</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add entry</span>)</span><br/>
<span class="in1"></span><span class="fn">assert</span>((<span class="type">int</span>) <span class="var">key</span>.<span class="fn">size</span>() == <span class="type">Key</span>::<span class="var">length</span> + <span class="num">1</span>);<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="var">i</span> { <span class="num">0</span> }; <span class="var">i</span> + <span class="num">1</span> &lt; <span class="var">key</span>.<span class="fn">size</span>(); ++<span class="var">i</span>) {<br/>
<span class="in2"></span><span class="var">k</span>.<span class="fn">push</span>(<span class="var">key</span>[<span class="var">i</span>]);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">collection</span>[<span class="var">k</span>].<span class="fn">add</span>(<span class="var">key</span>.<span class="fn">back</span>(), <span class="var">count</span>);<br/>
<span class="macro">@end(<span class="name">add entry</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">next</span>)</span><br/>
<span class="macro">@end(<span class="name">next</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">initialise</span>)</span><br/>
<span class="macro">@end(<span class="name">initialise</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">next prereqs</span>)</span><br/>
<span class="in1"></span><span class="type">Key</span> <span class="var">prev</span>;<br/>
<span class="macro">@end(<span class="name">next prereqs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">initialise</span>)</span><br/>
<span class="in1"></span><span class="var">prev</span> = <span class="type">Key</span> { };<br/>
<span class="macro">@end(<span class="name">initialise</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@rep(<span class="name">next</span>)</span><br/>
<span class="in1"></span><span class="var">ch</span> = <span class="var">collection</span>[<span class="var">prev</span>].<span class="fn">next</span>();<br/>
<span class="in1"></span><span class="var">ok</span> = <span class="var">ch</span> != <span class="str">'\0'</span>;<br/>
<span class="in1"></span><span class="var">prev</span>.<span class="fn">push</span>(<span class="var">ch</span>);<br/>
<span class="macro">@end(<span class="name">next</span>)</span><br/>
</code></div>
</div>
</body>
</html>
